{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.OggParser = exports.SegmentTable = void 0;\n\nconst Token = require(\"token-types\");\n\nconst initDebug = require(\"debug\");\n\nconst assert = require(\"assert\");\n\nconst Util_1 = require(\"../common/Util\");\n\nconst FourCC_1 = require(\"../common/FourCC\");\n\nconst VorbisParser_1 = require(\"./vorbis/VorbisParser\");\n\nconst OpusParser_1 = require(\"./opus/OpusParser\");\n\nconst SpeexParser_1 = require(\"./speex/SpeexParser\");\n\nconst BasicParser_1 = require(\"../common/BasicParser\");\n\nconst TheoraParser_1 = require(\"./theora/TheoraParser\");\n\nconst core_1 = require(\"strtok3/lib/core\");\n\nconst debug = initDebug('music-metadata:parser:ogg');\n\nclass SegmentTable {\n  constructor(header) {\n    this.len = header.page_segments;\n  }\n\n  static sum(buf, off, len) {\n    let s = 0;\n\n    for (let i = off; i < off + len; ++i) {\n      s += buf[i];\n    }\n\n    return s;\n  }\n\n  get(buf, off) {\n    return {\n      totalPageSize: SegmentTable.sum(buf, off, this.len)\n    };\n  }\n\n}\n\nexports.SegmentTable = SegmentTable;\n/**\n * Parser for Ogg logical bitstream framing\n */\n\nclass OggParser extends BasicParser_1.BasicParser {\n  /**\n   * Parse page\n   * @returns {Promise<void>}\n   */\n  async parse() {\n    debug('pos=%s, parsePage()', this.tokenizer.position);\n\n    try {\n      let header;\n\n      do {\n        header = await this.tokenizer.readToken(OggParser.Header);\n        assert.strictEqual(header.capturePattern, 'OggS', 'Ogg capture pattern');\n        this.metadata.setFormat('container', 'Ogg');\n        this.header = header;\n        this.pageNumber = header.pageSequenceNo;\n        debug('page#=%s, Ogg.id=%s', header.pageSequenceNo, header.capturePattern);\n        const segmentTable = await this.tokenizer.readToken(new SegmentTable(header));\n        debug('totalPageSize=%s', segmentTable.totalPageSize);\n        const pageData = await this.tokenizer.readToken(new Token.BufferType(segmentTable.totalPageSize));\n        debug('firstPage=%s, lastPage=%s, continued=%s', header.headerType.firstPage, header.headerType.lastPage, header.headerType.continued);\n\n        if (header.headerType.firstPage) {\n          const id = new Token.StringType(7, 'ascii').get(pageData, 0);\n\n          switch (id) {\n            case '\u0001vorbis':\n              // Ogg/Vorbis\n              debug('Set page consumer to Ogg/Vorbis');\n              this.pageConsumer = new VorbisParser_1.VorbisParser(this.metadata, this.options);\n              break;\n\n            case 'OpusHea':\n              // Ogg/Opus\n              debug('Set page consumer to Ogg/Opus');\n              this.pageConsumer = new OpusParser_1.OpusParser(this.metadata, this.options, this.tokenizer);\n              break;\n\n            case 'Speex  ':\n              // Ogg/Speex\n              debug('Set page consumer to Ogg/Speex');\n              this.pageConsumer = new SpeexParser_1.SpeexParser(this.metadata, this.options, this.tokenizer);\n              break;\n\n            case 'fishead':\n            case '\u0000theora':\n              // Ogg/Theora\n              debug('Set page consumer to Ogg/Theora');\n              this.pageConsumer = new TheoraParser_1.TheoraParser(this.metadata, this.options, this.tokenizer);\n              break;\n\n            default:\n              throw new Error('gg audio-codec not recognized (id=' + id + ')');\n          }\n        }\n\n        this.pageConsumer.parsePage(header, pageData);\n      } while (!header.headerType.lastPage);\n    } catch (err) {\n      if (err instanceof core_1.EndOfStreamError) {\n        this.metadata.addWarning('Last OGG-page is not marked with last-page flag');\n        debug(`End-of-stream`);\n        this.metadata.addWarning('Last OGG-page is not marked with last-page flag');\n\n        if (this.header) {\n          this.pageConsumer.calculateDuration(this.header);\n        }\n      } else if (err.message.startsWith('FourCC')) {\n        if (this.pageNumber > 0) {\n          // ignore this error: work-around if last OGG-page is not marked with last-page flag\n          this.metadata.addWarning('Invalid FourCC ID, maybe last OGG-page is not marked with last-page flag');\n          this.pageConsumer.flush();\n        }\n      } else {\n        throw err;\n      }\n    }\n  }\n\n}\n\nexports.OggParser = OggParser;\nOggParser.Header = {\n  len: 27,\n  get: (buf, off) => {\n    return {\n      capturePattern: FourCC_1.FourCcToken.get(buf, off),\n      version: buf.readUInt8(off + 4),\n      headerType: {\n        continued: Util_1.default.strtokBITSET.get(buf, off + 5, 0),\n        firstPage: Util_1.default.strtokBITSET.get(buf, off + 5, 1),\n        lastPage: Util_1.default.strtokBITSET.get(buf, off + 5, 2)\n      },\n      // packet_flag: buf.readUInt8(off + 5),\n      absoluteGranulePosition: buf.readIntLE(off + 6, 6),\n      streamSerialNumber: Token.UINT32_LE.get(buf, off + 14),\n      pageSequenceNo: Token.UINT32_LE.get(buf, off + 18),\n      pageChecksum: Token.UINT32_LE.get(buf, off + 22),\n      page_segments: buf.readUInt8(off + 26)\n    };\n  }\n};","map":{"version":3,"sources":["/Users/inge/Sites/kit-kulturpunkt/node_modules/music-metadata/lib/ogg/OggParser.js"],"names":["Object","defineProperty","exports","value","OggParser","SegmentTable","Token","require","initDebug","assert","Util_1","FourCC_1","VorbisParser_1","OpusParser_1","SpeexParser_1","BasicParser_1","TheoraParser_1","core_1","debug","constructor","header","len","page_segments","sum","buf","off","s","i","get","totalPageSize","BasicParser","parse","tokenizer","position","readToken","Header","strictEqual","capturePattern","metadata","setFormat","pageNumber","pageSequenceNo","segmentTable","pageData","BufferType","headerType","firstPage","lastPage","continued","id","StringType","pageConsumer","VorbisParser","options","OpusParser","SpeexParser","TheoraParser","Error","parsePage","err","EndOfStreamError","addWarning","calculateDuration","message","startsWith","flush","FourCcToken","version","readUInt8","default","strtokBITSET","absoluteGranulePosition","readIntLE","streamSerialNumber","UINT32_LE","pageChecksum"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.OggParser = exports.SegmentTable = void 0;\nconst Token = require(\"token-types\");\nconst initDebug = require(\"debug\");\nconst assert = require(\"assert\");\nconst Util_1 = require(\"../common/Util\");\nconst FourCC_1 = require(\"../common/FourCC\");\nconst VorbisParser_1 = require(\"./vorbis/VorbisParser\");\nconst OpusParser_1 = require(\"./opus/OpusParser\");\nconst SpeexParser_1 = require(\"./speex/SpeexParser\");\nconst BasicParser_1 = require(\"../common/BasicParser\");\nconst TheoraParser_1 = require(\"./theora/TheoraParser\");\nconst core_1 = require(\"strtok3/lib/core\");\nconst debug = initDebug('music-metadata:parser:ogg');\nclass SegmentTable {\n    constructor(header) {\n        this.len = header.page_segments;\n    }\n    static sum(buf, off, len) {\n        let s = 0;\n        for (let i = off; i < off + len; ++i) {\n            s += buf[i];\n        }\n        return s;\n    }\n    get(buf, off) {\n        return {\n            totalPageSize: SegmentTable.sum(buf, off, this.len)\n        };\n    }\n}\nexports.SegmentTable = SegmentTable;\n/**\n * Parser for Ogg logical bitstream framing\n */\nclass OggParser extends BasicParser_1.BasicParser {\n    /**\n     * Parse page\n     * @returns {Promise<void>}\n     */\n    async parse() {\n        debug('pos=%s, parsePage()', this.tokenizer.position);\n        try {\n            let header;\n            do {\n                header = await this.tokenizer.readToken(OggParser.Header);\n                assert.strictEqual(header.capturePattern, 'OggS', 'Ogg capture pattern');\n                this.metadata.setFormat('container', 'Ogg');\n                this.header = header;\n                this.pageNumber = header.pageSequenceNo;\n                debug('page#=%s, Ogg.id=%s', header.pageSequenceNo, header.capturePattern);\n                const segmentTable = await this.tokenizer.readToken(new SegmentTable(header));\n                debug('totalPageSize=%s', segmentTable.totalPageSize);\n                const pageData = await this.tokenizer.readToken(new Token.BufferType(segmentTable.totalPageSize));\n                debug('firstPage=%s, lastPage=%s, continued=%s', header.headerType.firstPage, header.headerType.lastPage, header.headerType.continued);\n                if (header.headerType.firstPage) {\n                    const id = new Token.StringType(7, 'ascii').get(pageData, 0);\n                    switch (id) {\n                        case '\u0001vorbis': // Ogg/Vorbis\n                            debug('Set page consumer to Ogg/Vorbis');\n                            this.pageConsumer = new VorbisParser_1.VorbisParser(this.metadata, this.options);\n                            break;\n                        case 'OpusHea': // Ogg/Opus\n                            debug('Set page consumer to Ogg/Opus');\n                            this.pageConsumer = new OpusParser_1.OpusParser(this.metadata, this.options, this.tokenizer);\n                            break;\n                        case 'Speex  ': // Ogg/Speex\n                            debug('Set page consumer to Ogg/Speex');\n                            this.pageConsumer = new SpeexParser_1.SpeexParser(this.metadata, this.options, this.tokenizer);\n                            break;\n                        case 'fishead':\n                        case '\u0000theora': // Ogg/Theora\n                            debug('Set page consumer to Ogg/Theora');\n                            this.pageConsumer = new TheoraParser_1.TheoraParser(this.metadata, this.options, this.tokenizer);\n                            break;\n                        default:\n                            throw new Error('gg audio-codec not recognized (id=' + id + ')');\n                    }\n                }\n                this.pageConsumer.parsePage(header, pageData);\n            } while (!header.headerType.lastPage);\n        }\n        catch (err) {\n            if (err instanceof core_1.EndOfStreamError) {\n                this.metadata.addWarning('Last OGG-page is not marked with last-page flag');\n                debug(`End-of-stream`);\n                this.metadata.addWarning('Last OGG-page is not marked with last-page flag');\n                if (this.header) {\n                    this.pageConsumer.calculateDuration(this.header);\n                }\n            }\n            else if (err.message.startsWith('FourCC')) {\n                if (this.pageNumber > 0) {\n                    // ignore this error: work-around if last OGG-page is not marked with last-page flag\n                    this.metadata.addWarning('Invalid FourCC ID, maybe last OGG-page is not marked with last-page flag');\n                    this.pageConsumer.flush();\n                }\n            }\n            else {\n                throw err;\n            }\n        }\n    }\n}\nexports.OggParser = OggParser;\nOggParser.Header = {\n    len: 27,\n    get: (buf, off) => {\n        return {\n            capturePattern: FourCC_1.FourCcToken.get(buf, off),\n            version: buf.readUInt8(off + 4),\n            headerType: {\n                continued: Util_1.default.strtokBITSET.get(buf, off + 5, 0),\n                firstPage: Util_1.default.strtokBITSET.get(buf, off + 5, 1),\n                lastPage: Util_1.default.strtokBITSET.get(buf, off + 5, 2)\n            },\n            // packet_flag: buf.readUInt8(off + 5),\n            absoluteGranulePosition: buf.readIntLE(off + 6, 6),\n            streamSerialNumber: Token.UINT32_LE.get(buf, off + 14),\n            pageSequenceNo: Token.UINT32_LE.get(buf, off + 18),\n            pageChecksum: Token.UINT32_LE.get(buf, off + 22),\n            page_segments: buf.readUInt8(off + 26)\n        };\n    }\n};\n//# sourceMappingURL=OggParser.js.map"]},"metadata":{},"sourceType":"script"}