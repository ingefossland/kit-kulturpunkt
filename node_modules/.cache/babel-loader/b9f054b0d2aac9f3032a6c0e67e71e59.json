{"ast":null,"code":"var _jsxFileName = \"/Users/inge/Sites/kit-kulturpunkt/src/Admin/DocumentEditor.js\";\nimport React, { useEffect, useState } from 'react';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { getAppLayout } from '../redux/app';\nimport { editModel, saveModel } from '../redux/editor';\nimport qs from 'query-string';\nimport Editor from \"../Editor/Editor\";\nimport EditorLoader from \"../Editor/EditorLoader\";\nimport schemasByName from \"../schemas/schemasByName\";\nimport { utils } from '@kit-ui/schema';\nconst {\n  getUiPreview,\n  getDefaultFormState\n} = utils;\n\nconst DocumentEditor = props => {\n  const {\n    uniqueId,\n    documentType\n  } = props.match.params;\n  const dispatch = useDispatch(); // new or create doc\n\n  useEffect(() => {\n    const {\n      pathname,\n      search\n    } = props.location;\n    const sq = search && qs.parse(search) || {};\n    documentType && dispatch(editModel({\n      collectionId: 14,\n      schemaId: 1,\n      locale: \"no\",\n      documentType: documentType,\n      content: sq.content && JSON.parse(sq.content) || {}\n    }));\n  }, [documentType]);\n  useEffect(() => {\n    uniqueId && dispatch(editModel({\n      uniqueId: uniqueId\n    }));\n  }, [uniqueId]); // uniqueId has changed, update location\n\n  const _onHistory = uniqueId => {\n    const {\n      path,\n      params\n    } = props.match;\n    const {\n      hash,\n      search\n    } = props.location;\n    let location = path;\n\n    if (hash) {\n      location = location + hash;\n    }\n\n    for (let key in params) {\n      let value;\n\n      if (key === \"uniqueId\") {\n        value = uniqueId;\n      } else if (key === \"documentType\") {\n        value = uniqueId;\n      } else {\n        value = params[key];\n      }\n\n      if (value) {\n        location = location.replace(':' + key + \"*\", value);\n        location = location.replace(':' + key, value);\n      } else {\n        location = location.replace(':' + key + \"*\", '');\n        location = location.replace(':' + key, '');\n      }\n\n      location = location.replace(\"//\", \"/\");\n    }\n\n    location = location.replace(\"new\", \"edit\");\n    props.history.replace(location);\n  };\n\n  const app = useSelector(state => state.app);\n  const formData = useSelector(state => state.editor); // set formContext\n\n  const _onBack = () => {\n    props.history.goBack();\n  };\n\n  const _onSelect = ({\n    url\n  }) => {\n    url && props.history.push(url);\n  };\n\n  const _onEditReference = ({\n    id,\n    formData: {\n      referenceId,\n      reference: {\n        documentType\n      }\n    }\n  }) => {\n    const referenceUrl = app.root + \"/\" + referenceId + \"/edit/#\" + id;\n    props.history.push({\n      pathname: referenceUrl,\n      search: \"?backUrl=\" + props.location.pathname + \"&backId=\" + id\n    });\n  };\n\n  const formContext = {\n    isLoading: formData && formData.isLoading,\n    isSaving: formData && formData.isSaving,\n    id: formData && formData.id,\n    uniqueId: formData && formData.uniqueId,\n    collectionId: formData && formData.collectionId,\n    parents: app && app.parents,\n    onBack: _onBack,\n    onSelect: _onSelect,\n    onEditReference: _onEditReference\n  }; // get schemas based on documentType\n\n  const modelType = uniqueId && formData && formData.documentType || documentType;\n  const documentModel = modelType && \"documents/\" + modelType;\n  const model = schemasByName && schemasByName[documentModel];\n  const schema = model && model.schema;\n  const uiSchema = model && model.uiSchema; // submit\n\n  const collectionId = useSelector(state => state.app.collectionId);\n\n  const _onSubmit = ({\n    formData\n  }) => {\n    const uiPreview = getUiPreview({\n      schema,\n      uiSchema,\n      formData\n    });\n    formData = { ...formData,\n      ...uiPreview,\n      collectionId: collectionId,\n      schemaId: 1,\n      locale: \"no\"\n    };\n    dispatch(saveModel(formData));\n\n    if (documentType && !uniqueId && formData.uniqueId) {\n      _onHistory(formData.uniqueId);\n    }\n  };\n\n  return /*#__PURE__*/React.createElement(EditorLoader, {\n    formData: formData,\n    schema: schema,\n    uiSchema: uiSchema,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 153,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Editor, Object.assign({}, props, {\n    schema: schema,\n    uiSchema: uiSchema,\n    formData: formData,\n    formContext: formContext,\n    preview: model && model.preview,\n    onSubmit: _onSubmit,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 154,\n      columnNumber: 13\n    }\n  })));\n};\n\nDocumentEditor.defaultProps = {};\nexport default DocumentEditor;","map":{"version":3,"sources":["/Users/inge/Sites/kit-kulturpunkt/src/Admin/DocumentEditor.js"],"names":["React","useEffect","useState","useSelector","useDispatch","getAppLayout","editModel","saveModel","qs","Editor","EditorLoader","schemasByName","utils","getUiPreview","getDefaultFormState","DocumentEditor","props","uniqueId","documentType","match","params","dispatch","pathname","search","location","sq","parse","collectionId","schemaId","locale","content","JSON","_onHistory","path","hash","key","value","replace","history","app","state","formData","editor","_onBack","goBack","_onSelect","url","push","_onEditReference","id","referenceId","reference","referenceUrl","root","formContext","isLoading","isSaving","parents","onBack","onSelect","onEditReference","modelType","documentModel","model","schema","uiSchema","_onSubmit","uiPreview","preview","defaultProps"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { getAppLayout } from '../redux/app';\nimport { editModel, saveModel } from '../redux/editor';\nimport qs from 'query-string';\n\nimport Editor from \"../Editor/Editor\"\nimport EditorLoader from \"../Editor/EditorLoader\"\n\nimport schemasByName from \"../schemas/schemasByName\"\n\nimport { utils } from '@kit-ui/schema';\nconst { getUiPreview, getDefaultFormState } = utils\n\nconst DocumentEditor = (props) => {\n    const { uniqueId, documentType } = props.match.params\n\n    const dispatch = useDispatch()\n\n    // new or create doc\n\n    useEffect(() => {\n        const { pathname, search } = props.location\n        const sq = search && qs.parse(search) || {}\n\n        documentType && dispatch(editModel({\n            collectionId: 14,\n            schemaId: 1,\n            locale: \"no\",\n            documentType: documentType,\n            content: sq.content && JSON.parse(sq.content) || {}\n        }))\n    }, [documentType])\n\n    useEffect(() => {\n        uniqueId && dispatch(editModel({uniqueId: uniqueId}))\n    }, [uniqueId])\n\n    // uniqueId has changed, update location\n\n    const _onHistory = (uniqueId) => {\n\n        const { path, params } = props.match;\n        const { hash, search } = props.location;\n        \n        let location = path;\n    \n        if (hash) {\n            location = location + hash;\n        }\n    \n        for (let key in params) {\n      \n            let value;\n          \n            if (key === \"uniqueId\") {\n                value = uniqueId\n            } else if (key === \"documentType\") {\n                value = uniqueId\n            } else {\n                value = params[key];\n            }\n\n            if (value) {\n                location = location.replace(':'+key+\"*\", value);\n                location = location.replace(':'+key, value);\n            } else {\n                location = location.replace(':'+key+\"*\", '');\n                location = location.replace(':'+key, '');\n            }\n\n            location = location.replace(\"//\", \"/\");\n\n        }\n\n        location = location.replace(\"new\", \"edit\");\n        props.history.replace(location);\n\n    }\n\n    const app = useSelector(state => state.app)\n    const formData = useSelector(state => state.editor)\n\n    // set formContext\n\n    const _onBack = () => {\n        props.history.goBack()\n    }\n\n    const _onSelect = ({url}) => {\n        url && props.history.push(url)\n    }\n\n    const _onEditReference = ({id, formData: { referenceId, reference: { documentType } }}) => {\n\n        const referenceUrl = app.root + \"/\" + referenceId + \"/edit/#\" + id\n\n        props.history.push({\n            pathname: referenceUrl,\n            search: \"?backUrl=\" + props.location.pathname + \"&backId=\" + id\n        })\n        \n\n    }\n\n    const formContext = {\n        isLoading: formData && formData.isLoading,\n        isSaving: formData && formData.isSaving,\n        id: formData && formData.id,\n        uniqueId: formData && formData.uniqueId,\n        collectionId: formData && formData.collectionId,\n        parents: app && app.parents,\n        onBack: _onBack,\n        onSelect: _onSelect,\n        onEditReference: _onEditReference\n    }\n\n    // get schemas based on documentType\n\n    const modelType = uniqueId && formData && formData.documentType || documentType\n    const documentModel = modelType && \"documents/\"+modelType \n    const model = schemasByName && schemasByName[documentModel]\n\n    const schema = model && model.schema\n    const uiSchema = model && model.uiSchema\n\n    // submit\n\n    const collectionId = useSelector(state => state.app.collectionId)\n\n    const _onSubmit = ({formData}) => {\n\n        const uiPreview = getUiPreview({schema, uiSchema, formData})\n        \n        formData = {\n            ...formData,\n            ...uiPreview,\n            collectionId: collectionId,\n            schemaId: 1,\n            locale: \"no\",\n        }\n\n        dispatch(saveModel(formData))\n\n        if (documentType && !uniqueId && formData.uniqueId) {\n            _onHistory(formData.uniqueId)\n        }\n\n    }\n\n\n    return (\n        <EditorLoader formData={formData} schema={schema} uiSchema={uiSchema}>\n            <Editor {...props}\n                schema={schema}\n                uiSchema={uiSchema}\n                formData={formData}\n                formContext={formContext}\n                preview={model && model.preview}\n                onSubmit={_onSubmit} />\n        </EditorLoader>\n    )\n\n}\n\nDocumentEditor.defaultProps = {\n}\n\nexport default DocumentEditor"]},"metadata":{},"sourceType":"module"}